import { calculateAnalytics, detectWeakAreas } from './analytics';

export const generateReport = (sessionData, questions) => {
    const { topic, results, startTime, endTime } = sessionData;
    const analytics = calculateAnalytics(results);
    const weakAreas = detectWeakAreas(results, questions);

    const formatDate = (date) => {
        return new Date(date).toLocaleString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
        });
    };

    const duration = ((endTime - startTime) / 1000 / 60).toFixed(1);

    let report = `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    ðŸ“Š SESSION REPORT                          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“… Date: ${formatDate(startTime)}
ðŸ“š Topic: ${topic}
â±ï¸ Duration: ${duration} minutes

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“ˆ PERFORMANCE SUMMARY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   Total Questions    : ${analytics.total}
   âœ… Correct          : ${analytics.correct}
   âŒ Wrong            : ${analytics.wrong}
   â­ï¸ Not Attempted    : ${analytics.notAttempted}
   
   ðŸŽ¯ Accuracy         : ${analytics.accuracy}%
   âš¡ Average Time     : ${analytics.avgTime} sec
   ðŸš€ Fastest Answer   : ${analytics.fastestTime} sec
   ðŸ¢ Slowest Answer   : ${analytics.slowestTime} sec

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âš ï¸ WEAK AREAS (Need Revision)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

`;

    if (weakAreas.length > 0) {
        weakAreas.forEach(area => {
            report += `   â€¢ ${area.topic} - ${area.accuracy}% (${area.status})\n`;
        });
    } else {
        report += `   âœ¨ Great job! No weak areas detected.\n`;
    }

    report += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ“ DETAILED QUESTION LOG
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

`;

    results.forEach((result, index) => {
        const question = questions.find(q => q.id === result.questionId);
        const statusEmoji = result.status === 'Correct' ? 'âœ…' :
            result.status === 'Wrong' ? 'âŒ' : 'â­ï¸';
        const timeStr = result.status === 'Not Attempted' ?
            'Time Out' : `${result.timeTaken.toFixed(1)}s`;

        report += `Q${index + 1}. ${question?.question?.substring(0, 50)}...\n`;
        report += `    ${statusEmoji} ${result.status} | â±ï¸ ${timeStr}\n`;

        if (result.status === 'Wrong') {
            report += `    Your Answer: ${String.fromCodePoint(65 + result.selectedAnswer)}\n`;
            report += `    Correct: ${String.fromCodePoint(65 + question?.correctIndex)}\n`;
        }
        report += '\n';
    });

    report += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ðŸ’¡ RECOMMENDATIONS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

`;

    if (analytics.accuracy >= 80) {
        report += `   ðŸŒŸ Excellent performance! Keep it up!\n`;
    } else if (analytics.accuracy >= 60) {
        report += `   ðŸ“– Good effort! Focus on weak areas.\n`;
    } else {
        report += `   ðŸ“š Needs improvement. Revise the basics.\n`;
    }

    if (analytics.avgTime > 8) {
        report += `   âš¡ Try to improve response time.\n`;
    }

    if (analytics.notAttempted > 0) {
        report += `   â° Work on time management for unattempted questions.\n`;
    }

    report += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Generated by Quiz Engine ðŸŽ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
`;

    return report;
};

// Download report as TXT file
export const downloadReport = (reportText, topic) => {
    const blob = new Blob([reportText], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    const timestamp = new Date().toISOString().split('T')[0];

    link.href = URL.createObjectURL(blob);
    link.download = `quiz_report_${topic.replaceAll(/\s+/g, '_')}_${timestamp}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(link.href);
};
